# 2.5. Система рівнів (Leveling System)

Цей документ описує повну специфікацію системи рівнів для бота, узгоджену з поточною архітектурою репозиторію (`discord.js v14+`, Prisma, розділення на `events/`, `modules/`, `services/`). Док забезпечує чіткі правила нарахування EXP, підвищення рівня, видачу ролей, таблиці лідерів, захист від зловживань, локалізацію, логування та продуктивність.

## Цілі
- Надихати активність у текстових і голосових каналах через прозору прогресію.
- Надавати рольові винагороди за досягнуті рівні (до 7 рівневих ролей).
- Забезпечити масштабованість (1k+ гільдій), мінімум REST-викликів, коректну роботу з rate limit, і стійкість до спаму.

## Визначення термінів
- EXP — очки досвіду, що нараховуються за активність (текст/voice).
- Рівень — метрика прогресу, що зростає з EXP за формулою кривої складності.
- Голосова активність — перебування у voice-каналі (з урахуванням AFK/м’ютів/ідеалів за політиками нижче).

## Джерела активності та базові правила
- Текст: за осмислені повідомлення (довжина ≥ 2 символи), з антиспам-кулдауном.
- Voice: за час у голосовому каналі, нарахування за фактичні секунди, мультиплікатор за повні хвилини.
- Боти і системні акаунти не отримують EXP.

### Нарахування EXP — Текст (`events/messageCreate.js`)
Поточний код вже виконує підготовчі дії (upsert `guild`, `user`, `member`) і підрахунок `msgCount`. Для EXP додаємо:
- Кулдаун на EXP за повідомлення: 60 секунд (налаштовувано на гільдію), щоб уникати спаму.
- Базова винагорода за повідомлення: 10 EXP (налаштовувано). Може бути випадковий розкид ±2 для природності.
- Фільтри:
  - ігнорувати повідомлення з довжиною < 2 символів;
  - ігнорувати повтор одних і тих самих повідомлень поспіль (опційно);
  - не нараховувати EXP у «ігнорованих каналах» (конфіг гільдії).

Псевдокод сервісу:
- `LevelingService.addMessageXp(guildId, userId, now)`:
  - перевірити кулдаун (зберігати `lastMsgXpAt` у окремій таблиці або в `member`),
  - якщо кулдаун минув → `member.xp += baseMsgXp` і `member.msgCount += 1` (вже є),
  - перерахувати рівень (див. нижче) і викликати `RoleService.syncLevelRoles` при зміні рівня.

### Нарахування EXP — Voice (`events/voiceStateUpdate.js`)
Поточний код вже рахує `voiceSeconds` та економіку за повні хвилини. Для EXP додаємо:
- На приєднання (join): зберігати `lastVoiceJoinedAt` (вже робиться в `economyBalance`), а також відмітку для leveling (рекомендовано мати окреме поле `member.lastVoiceJoinedAt` або `levelingState.lastVoiceJoinedAt`).
- На вихід/переміщення: підрахунок секунд перебування (вже робиться → `member.voiceSeconds += seconds`).
- Конвертація у EXP:
  - За кожну повну хвилину голосу: +5 EXP (налаштовувано).
  - За неповні хвилини EXP не додаються, але `voiceSeconds` накопичуються.
- Політики антизловживань:
  - Не нараховувати EXP у AFK-каналі.
  - Опційно: не нараховувати EXP користувачу, що сам себе зам’ютив і/або заглушив звук (self-mute/self-deaf). Політика вмикається в налаштуваннях гільдії.
  - Мінімальна кількість одночасних учасників у каналі для нарахування (наприклад, ≥ 2) — опція гільдії.

Псевдокод сервісу:
- `LevelingService.addVoiceXp(guildId, userId, seconds, participantsCount, isAfk, isSelfMuted, isSelfDeaf)`:
  - застосувати політики (AFK/самом’ют/мін.учасники) → заборонити EXP якщо порушені;
  - `fullMinutes = floor(seconds / 60)` → `xp += fullMinutes * baseVoiceXp`;
  - `member.voiceSeconds += seconds`;
  - якщо `xp > 0` → `member.xp += xp`, перерахувати рівень, синхронізувати ролі.

## Формула рівня та крива EXP
Рекомендована крива (класика для Discord-ботів):
- EXP до наступного рівня: `required(level) = 5 * (level - 1)^2 + 50 * (level - 1) + 100` (згідно з вимогою). Це означає, що для переходу з 0 → 1 потрібно 100 EXP, з 1 → 2 — 155 EXP тощо.
- Сукупний рівень визначається як найбільший `L`, для якого `totalXp >= sum(required(0..L-1))`.
- Альтернатива (простішa): `level = floor(0.1 * sqrt(totalXp))`. Але перший варіант дає кращий темп прогресії і контроль за порогами рівневих ролей.

Впровадження:
- Зберігати `member.xp` (total), `member.level` (кеш-поле), оновлювати `member.level` при кожному додаванні EXP.
- Атомарні оновлення через Prisma `update`/`upsert` (використовуються вже зараз).

## Рівневі ролі (до 7 ролей)
Семантика: при досягненні рівня видається відповідна роль. Назви за замовчуванням (можуть локалізуватися):
1. Прибулий
2. Мандрівник
3. Досвідчений
4. Наглядач
5. Майстер
6. Хранитель
7. Вартовий Вордемору

Налаштування на гільдію:
- Масив до 7 записів: `{ roleId, minLevel }` у конфігурації гільдії (таблиця `guildConfig` або `levelingRole`-mapping у Prisma).
- Політика видачі:
  - За замовчуванням зберігати тільки найвищу роль із досягнутих (щоб не засмічувати ролі) — опція `stacking: false`.
  - Опція `stacking: true` — додавати всі досягнуті рівневі ролі.
- При зниженні рівня (якщо таке можливе політично) — синхронізувати ролі назад.
- Видача/зняття ролей має відбуватись через чергу REST-запитів з урахуванням rate limit і повторів з джиттером при 429.

Сервіс:
- `RoleService.syncLevelRoles(guild, memberId, newLevel)`:
  - зчитати конфіг гільдії для ролей;
  - обчислити цільовий набір ролей за політикою `stacking`;
  - порівняти з поточним станом → виконати мінімальну кількість змін (додавання/видалення) з кешуванням `guild.roles.cache`.

## Таблиці лідерів
Передбачено 3 таблиці:
- Загальна за рівнями/EXP: `top level/exp` (сукупний прогрес).
- Voice-активність: топ за `voiceSeconds`.
- Текстова активність: топ за `msgCount`.

Реалізація:
- Команди `/top` з підкомандами: `levels`, `voice`, `text` і параметром `scope` (`guild` або `global`, якщо глобальний рейтинг доречний).
- Пагінація 10-20 записів на сторінку. Використовувати кнопки з підписаними custom IDs (підпис/верифікація ID згідно з правилами безпеки).
- Кешування результатів на 30-60 секунд (TTL) для скорочення навантаження БД.

## Команди взаємодії (Slash/Components)
Рекомендований мінімум:
- `/rank [user]` — показати поточний рівень, EXP, прогрес до наступного рівня, позицію в топі гільдії.
- `/top levels|voice|text [page]` — таблиці лідерів.
- `/settings leveling` — GUI налаштувань (епемерально для адміністраторів):
  - вкл/викл leveling;
  - `baseMsgXp`, `msgXpCooldownSec`, `baseVoiceXpPerMinute`;
  - політики AFK/self-mute/мін.учасники;
  - менеджер рівневих ролей: 1..7 слотів (`roleId`, `minLevel`, `stacking`).

Структура файлів (у відповідності до проектних правил):
- `src/modules/leveling/`:
  - `commands/` → `rank.js`, `top.js`, `settings-leveling.js` (або інтеграція в існуюче `utility/commands/settings.js`).
  - `services/LevelingService.js` → логіка EXP/level.
  - `services/RoleService.js` → синхронізація ролей.
- Події:
  - `src/events/messageCreate.js` → виклик `LevelingService.addMessageXp` (після існуючої логіки `msgCount`).
  - `src/events/voiceStateUpdate.js` → виклик `LevelingService.addVoiceXp` при `leftNow || movedNow` і розрахованих секундах.

## Схема даних (Prisma — поточні поля і розширення)
В репозиторії вже використовуються таблиці: `guild`, `user`, `member` (має `xp`, `level`, `msgCount`, `voiceSeconds`), та `economyBalance` з полями `lastMsgEarnAt`, `lastVoiceJoinedAt`. Для leveling рекомендується:
- Розширити `member`:
  - `lastMsgXpAt DateTime?` — останній час, коли було нараховано EXP за повідомлення (кулдаун);
- Або окрема таблиця `memberLevelingState`:
  - `guildId`, `userId` (PK/FK), `lastMsgXpAt`, `lastVoiceJoinedAt`?
- Таблиця конфігів гільдії (якщо ще немає): `guildConfig` з `levelingEnabled`, `baseMsgXp`, `msgXpCooldownSec`, `baseVoiceXpPerMinute`, `afkPolicyEnabled`, `selfMutePolicy`, `minParticipants` тощо.
- Таблиця `levelingRole` для mapping ролей: `id`, `guildId`, `roleId`, `minLevel`, `order`.

Міграції повинні враховувати наявні дані і працювати без простоїв. Запланувати індекси по `member(guildId, xp DESC)`, `member(guildId, voiceSeconds DESC)`, `member(guildId, msgCount DESC)`.

## Обчислення рівня (алгоритм)
- При додаванні EXP:
  1. Прочитати `member.xp`, `member.level`.
  2. Додати `deltaXp`.
  3. Ітераційно/через бінпоіск знайти новий рівень за кумулятивною кривою.
  4. Якщо `newLevel > oldLevel` → тригерити `RoleService.syncLevelRoles` та повідомлення користувачу (епемеральне / системне в канал — за налаштуваннями).

## Антизловживання
- Кулдауни на повідомлення (EXP і, опційно, економіка роздільно).
- Ігнор каналів/ролей для нарахувань.
- AFK/self-mute/self-deaf/мін.учасники політики у voice.
- Фільтрація спаму: однакові повтори, надто часті короткі репліки.
- Серверні ліміти (feature flag) для інтенсивності нарахувань.

## UX і локалізація
- Відповіді команд — лаконічні embeds з прогресбаром до наступного рівня.
- Епемеральні відповіді для адміністраторських налаштувань.
- Тексти — з `/locales/{lang}.json`, визначення мови за `interaction.locale` або налаштуваннями гільдії.

## Логування і моніторинг
- Структуровані логи JSON: `{ level, ts, guildId, userId, operation, deltaXp, newLevel, latencyMs }`.
- Метрики для Prometheus: `leveling_xp_added_total`, `leveling_role_sync_total`, `leveling_leaderboard_latency_ms`.
- Алерти на підвищені 429 або помилки синхронізації ролей.

## Продуктивність
- Кеш конфігів гільдій з TTL.
- Батчеві вибірки для таблиць лідерів (LIMIT + OFFSET, або cursor-сторінкація).
- Мінімізація REST-викликів при рольових оновленнях (диф поточного/цільового набору ролей).
- Важкі обчислення (ре-ранжування топів) — у воркери/черги.

## Приклади значень за замовчуванням
- `baseMsgXp = 10`
- `msgXpCooldownSec = 60`
- `baseVoiceXpPerMinute = 5`
- `minParticipants = 2` (опційно, вимкнено за замовчуванням)
- `stacking = false`

## План впровадження (ітерації)
1. Сервіси `LevelingService`, `RoleService` + інтеграція у `messageCreate` і `voiceStateUpdate`.
2. Prisma-міграції для полів кулдаунів/конфігів/ролей.
3. Команди `/rank`, `/top`, оновлення `settings` для leveling.
4. Локалізація і логування/метрики.
5. Оптимізації кешів, батчі, політики AFK/self-mute.

---

Ця специфікація сумісна з поточною моделлю даних (`member: xp, level, msgCount, voiceSeconds`) і подієвою архітектурою. Подальша імплементація не порушує існуючу економіку і розширює її незалежно.
